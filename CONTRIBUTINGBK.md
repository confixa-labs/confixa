# Contributing to Confixa Helm Charts

Confixa Helm Charts is a collection of **community-maintained** charts. Therefore, we rely on you to test your changes sufficiently.

## Pull Requests

All submissions, including those from project members, require review. We use GitHub pull requests for this purpose. Consult [GitHub Help](https://help.github.com/articles/about-pull-requests/) for more information on using pull requests. Please see the above-stated requirements for pull requests on this project.

### Pull Request Title Linting

We lint the title of your pull request to ensure it follows the [Conventional Commits](https://www.conventionalcommits.org/en/v1.0.0/) specification. This is done using GitHub actions and the [action-semantic-pull-request](.github/workflows/pr-title.yml) workflow. We require the scope of the change to be included in the title. The scope should be the name of the chart you are changing. For example, if you are changing the `confixa-app` chart, the title of your pull request should be `fix(confixa-app): Fix typo in values.yaml`.

## Documentation

The documentation for each chart is generated with [helm-docs](https://github.com/norwoodj/helm-docs). This way, we can ensure that values are consistent with the chart documentation.

We have a script in the repository which will execute the `helm-docs` docker container, so you donâ€™t have to worry about downloading the binary, etc. Simply execute the script (Bash compatible, might require sudo privileges):

```shell
./scripts/helm-docs.sh
```

> **Note**
> When creating your own `README.md.gotmpl`, don't forget to add it to your `.helmignore` file.

### Updating a chart README.md

When updating the `README.md.gotmpl` inside a chart directory, you must run the `helm-docs` script to generate the updated `README.md` file. To reiterate, you should not edit the `README.md` file manually. It will be generated by the following command:

```shell
./scripts/helm-docs.sh
```

> **Note**
> If you see changes to unrelated chart `README.md` files, you may have accidentally updated a `README.md.gotmpl` file in another chart's folder unintentionally or someone else failed to run this script. Please revert those changes if they do not intend to be part of your pull request.

## Versioning

Each chart's version follows the [semver standard](https://semver.org/).

New charts should start at version `1.0.0` if they are considered stable. If they are not considered stable, they must be released as `prerelease`.

Any breaking changes to a chart (backwards incompatible) require:

* Bump of the current Major version of the chart
* State possible manual changes for this chart version in the `Upgrading` section of the chart's `README.md.gotmpl`

### New Application Versions

Helm charts are intended to be created for all non-patched releases of **Confixa**. Associated dependencies, such as Redis, will use the version recommended by the associated release.

When selecting new application versions, ensure you make the following changes:

* `values.yaml`: Bump all instances of the container image version
* `Chart.yaml`: Ensure `appVersion` matches the above container image and bump `version`

Please ensure chart version changes adhere to semantic versioning standards:

* **Major**: Large chart rewrites, major non-backwards compatible, or destructive changes
* **Minor**: New chart functionality (e.g., sidecars), major application updates, or minor non-backwards compatible changes
* **Patch**: App version patch updates, backwards-compatible optional chart features

### Immutability

Each release for each chart must be immutable. Any change to a chart (even just documentation) requires a version bump. Trying to release the same version twice will result in an error.

### Chart Versioning

Currently, we require a chart version bump for every change to a chart, including updating information for older versions. This may change in the future.

### Artifact Hub Annotations

Since we release our charts on [Artifact Hub](https://artifacthub.io), we encourage making use of the provided chart annotations for Artifact Hub.

* [Artifact Hub Annotations Documentation](https://artifacthub.io/docs/topics/annotations/helm/)

#### Changelog

We want to deliver transparent chart releases for our chart consumers. Therefore, we require a changelog for each new chart release.

Changes to a chart must be documented in a chart-specific changelog in the `Chart.yaml` [Annotation Section](https://helm.sh/docs/topics/charts/#the-chartyaml-file).

A new `artifacthub.io/changes` needs to be written covering only the changes since the previous release.

Each change requires a new bullet point following the pattern. See more information about [Artifact Hub annotations in Helm Chart.yaml file](https://artifacthub.io/docs/topics/annotations/helm/).

```yaml
- kind: {type}
  description: {description}
```

You can use the following template:

```yaml
name: confixa-app
version: 1.0.0
...
annotations:
  artifacthub.io/changes: |
    - kind: added
      description: Something new was added
    - kind: changed
      description: Changed something within this chart
    - kind: changed
      description: Changed something else within this chart
    - kind: deprecated
      description: Something deprecated
    - kind: removed
      description: Something was removed
    - kind: fixed
      description: Something was fixed
    - kind: security
      description: Some security patch was included
```

## Testing

### Testing Confixa Application Changes

Minimally:

```shell
helm install charts/confixa-app -n confixa
kubectl version
```

Follow [these](https://kubernetes.io/docs/tasks/tools/) instructions for running the application.

### Testing Charts

As part of the Continuous Integration system, we run Helm's [Chart Testing](https://github.com/helm/chart-testing) tool.

The checks for Chart Testing are stricter than the standard Helm requirements. For example, fields normally considered optional, like `maintainer`, are required in the standard spec and must be valid GitHub usernames.

Linting configuration can be found in [ct-lint.yaml](./.github/configs/ct-lint.yaml)

The linting can be invoked manually with the following command:

```shell
./scripts/lint.sh
```

## Publishing Changes

Changes are automatically published whenever a commit is merged into the `main` branch by the CI job (see `./.github/workflows/publish.yml`).
